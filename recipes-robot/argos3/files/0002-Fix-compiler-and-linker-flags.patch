From c9500782fd3af9c394645ee3d7562f1a6032cd6f Mon Sep 17 00:00:00 2001
From: Michael Allwright <allsey87@gmail.com>
Date: Mon, 12 Apr 2021 14:49:42 +0200
Subject: [PATCH 2/2] Fix compiler and linker flags

---
 src/cmake/ARGoSBuildFlags.cmake | 39 ++++++++++-----------------------
 1 file changed, 12 insertions(+), 27 deletions(-)

diff --git a/src/cmake/ARGoSBuildFlags.cmake b/src/cmake/ARGoSBuildFlags.cmake
index ff401ea9..764d9a08 100644
--- a/src/cmake/ARGoSBuildFlags.cmake
+++ b/src/cmake/ARGoSBuildFlags.cmake
@@ -23,36 +23,21 @@ set(CMAKE_CXX_EXTENSIONS OFF)
 #
 # General compilation flags
 #
-set(CMAKE_C_FLAGS "-Wall -Wno-unknown-pragmas")
+set(CMAKE_C_FLAGS                  "${CMAKE_C_FLAGS} -Wall -Wno-unknown-pragmas")
 if(ARGOS_BUILD_NATIVE)
-  string(APPEND CMAKE_C_FLAGS "-mtune=native -march=native")
+  set(CMAKE_C_FLAGS                "${CMAKE_C_FLAGS} -mtune=native -march=native")
 endif(ARGOS_BUILD_NATIVE)
-set(CMAKE_C_FLAGS_RELEASE "-O3 -DNDEBUG")
-set(CMAKE_C_FLAGS_DEBUG "-ggdb3")
-set(CMAKE_C_FLAGS_RELWITHDEBINFO "${CMAKE_C_FLAGS_DEBUG} ${CMAKE_C_FLAGS_RELEASE}")
-set(CMAKE_CXX_FLAGS "-Wall -Wno-unknown-pragmas")
+set(CMAKE_C_FLAGS_RELEASE          "${CMAKE_C_FLAGS_RELEASE} -O3 -DNDEBUG")
+set(CMAKE_C_FLAGS_DEBUG            "${CMAKE_C_FLAGS_DEBUG} -ggdb3")
+set(CMAKE_C_FLAGS_RELWITHDEBINFO   "${CMAKE_C_FLAGS_RELWITHDEBINFO} ${CMAKE_C_FLAGS_DEBUG} ${CMAKE_C_FLAGS_RELEASE}")
+
+set(CMAKE_CXX_FLAGS                "${CMAKE_CXX_FLAGS} -Wall -Wno-unknown-pragmas")
 if(ARGOS_BUILD_NATIVE)
-  string(APPEND CMAKE_CXX_FLAGS "-mtune=native -march=native")
+  set(CMAKE_CXX_FLAGS              "${CMAKE_CXX_FLAGS} -mtune=native -march=native")
 endif(ARGOS_BUILD_NATIVE)
-set(CMAKE_CXX_FLAGS_RELEASE        "-O3 -DNDEBUG")
-set(CMAKE_CXX_FLAGS_DEBUG          "-ggdb3")
-set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELEASE} ${CMAKE_CXX_FLAGS_DEBUG}")
-
-#
-# Reset linker flags
-#
-unset(CMAKE_EXE_LINKER_FLAGS CACHE)
-unset(CMAKE_EXE_LINKER_FLAGS_DEBUG CACHE)
-unset(CMAKE_EXE_LINKER_FLAGS_RELEASE CACHE)
-unset(CMAKE_EXE_LINKER_FLAGS_RELWITHDEBINFO CACHE)
-unset(CMAKE_SHARED_LINKER_FLAGS CACHE)
-unset(CMAKE_SHARED_LINKER_FLAGS_DEBUG CACHE)
-unset(CMAKE_SHARED_LINKER_FLAGS_RELEASE CACHE)
-unset(CMAKE_SHARED_LINKER_FLAGS_RELWITHDEBINFO CACHE)
-unset(CMAKE_MODULE_LINKER_FLAGS CACHE)
-unset(CMAKE_MODULE_LINKER_FLAGS_DEBUG CACHE)
-unset(CMAKE_MODULE_LINKER_FLAGS_RELEASE CACHE)
-unset(CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO CACHE)
+set(CMAKE_CXX_FLAGS_RELEASE        "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")
+set(CMAKE_CXX_FLAGS_DEBUG          "${CMAKE_CXX_FLAGS_DEBUG} -ggdb3")
+set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELWITHDEBINFO} ${CMAKE_CXX_FLAGS_RELEASE} ${CMAKE_CXX_FLAGS_DEBUG}")
 
 if(APPLE)
   # MAC OSX
@@ -75,7 +60,7 @@ if(APPLE)
 else(APPLE)
   # Linux
   # Avoid discarding unused symbols to allow plugins to work
-  set(CMAKE_SHARED_LINKER_FLAGS "-Wl,--no-as-needed")
+  set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--no-as-needed")
   set(ARGOS_SHARED_LIBRARY_EXTENSION "so")
   set(ARGOS_MODULE_LIBRARY_EXTENSION "so")
   set(ARGOS_DYNAMIC_LIBRARY_VARIABLE "LD_LIBRARY_PATH")
-- 
2.25.1

